# ARCHITECTURE.md — Архитектура Нейрона

_Проект: Neiron-AI-assistant_

📚 **Навигация:** [INDEX.md](./.ai/INDEX.md) — единая точка входа

---

## 🎯 Философия проекта

> _"Персональный AI-ассистент, который реально делает дела: читает новости, помнит контекст, работает с файлами и живёт в Telegram — без облачных сервисов и утечки данных."_

Нейрон — self-hosted агент на базе OpenClaw. Работает на Hetzner VPS, общается через Telegram, использует GPT-5.2 как мозг, и подключён к Mac через Tailscale VPN.

---

## 🏗️ Архитектура системы

```
                         🌐 ИНТЕРНЕТ
                              │
              ┌───────────────┴───────────────┐
              │                               │
         📱 Telegram                    🔍 Brave Search API
         @neironassistant_bot           (веб-поиск новостей)
              │                               │
              └───────────────┬───────────────┘
                              │
┌─────────────────────────────▼──────────────────────────────┐
│              HETZNER VPS (46.224.221.0)                     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │         OpenClaw Gateway (systemd, порт 18789)       │   │
│  │              + Telegram Bot                          │   │
│  └──────────────────────┬──────────────────────────────┘   │
│                         │                                   │
│         ┌───────────────┼───────────────┐                  │
│         ▼               ▼               ▼                  │
│   🧠 GPT-5.2      📰 Новостной    🗄️ Память                │
│   (OpenAI)          агрегатор       (bank + LanceDB)         │
│                   (cron + Brave)  (OpenAI embeddings)      │
│                         │                                   │
│              ┌──────────┼──────────┐                       │
│              ▼          ▼          ▼                       │
│         📊 Dual     🎲 Multi-    🎤 Groq                   │
│         Rating      Armed        Whisper                   │
│         System      Bandit       (voice→text)              │
└──────────────────────┬──────────────────────────────────────┘
                       │ Tailscale VPN (100.x.x.x)
                       │ (шифрованный туннель)
┌──────────────────────▼──────────────────────────────────────┐
│              MAC (margulansmacbookpro)                       │
│  ┌─────────────────────────────────────────────────────┐    │
│  │     OpenClaw Node (LaunchAgent, ai.openclaw.node)    │    │
│  │     Доступ: ~/Downloads, ~/Desktop, ~/Documents      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## Ключевые концепции

| Концепция                | Описание                                                          |
| ------------------------ | ----------------------------------------------------------------- |
| **Self-hosted**          | Всё работает на собственном сервере — никакой утечки данных       |
| **Персистентная память** | Bank-структура + LanceDB + дневные логи — бот помнит контекст     |
| **Адаптивный дайджест**  | Multi-armed bandit — алгоритм сам учится, какие источники лучше   |
| **Dual Rating**          | Раздельная оценка источника и эксперта через реакции Telegram     |
| **Heartbeat**            | Периодические проверки email/календаря без явного запроса         |
| **Git Sync**             | workspace бота = git-репо → синхронизация Telegram ↔ GitHub ↔ Mac |

---

## Уровни системы

### 1. Транспорт (Telegram ↔ Gateway)

**Что это:** Точка входа для всех команд и сообщений пользователя.

**Характеристики:**

- Webhook-интеграция Telegram → OpenClaw Gateway
- Allowlist: только Telegram ID `685668909`
- Нативные emoji-реакции как обратная связь для рейтинга
- Команды: `/restart`, `/reset`, `/new`, `/compact`, `/digest`, `/git`

### 2. Мозг (GPT-5.2)

**Что это:** LLM-ядро, принимает решения и генерирует ответы.

**Характеристики:**

- Модель: `openai/gpt-5.2`
- Context pruning: `safeguard`
- Session memory + memory flush перед компактификацией
- Workspace-файлы как долгосрочная память агента

### 3. Новостной агрегатор

**Что это:** Автономная подсистема сбора и публикации новостей.

**Характеристики:**

- 3 дайджеста в день: 08:00, 13:00, 18:00 (местное время)
- 7 категорий по приоритету: ИИ → Робо → eVTOL → Вайбкодинг → Тех → Бизнес → Инвест
- Дедупликация через `data/sent-digests.json`
- Multi-armed bandit: 70% проверенные / 30% новые источники
- Dual-рейтинг через нативные реакции Telegram

### 4. Память

**Что это:** Многоуровневая система сохранения контекста.

**Характеристики:**

- `MEMORY.md` — кураторская долгосрочная память (только в main session)
- `bank/` — структурированная: world.md, experience.md, opinions.md, entities/
- `memory/YYYY-MM-DD.md` — дневные сырые логи
- LanceDB + OpenAI embeddings — семантический поиск по истории

### 5. Mac Node

**Что это:** Расширение возможностей бота на локальный Mac.

**Характеристики:**

- Tailscale IP: `100.88.178.82`
- Доступ к файлам: ~/Downloads, ~/Desktop, ~/Documents, ~/Pictures
- Allowlist команд (безопасный exec)
- Транзакционные бэкапы перед любым удалением

---

## Логика работы

### Основной flow (запрос пользователя)

```
1. Пользователь → сообщение в Telegram
   └── Webhook → OpenClaw Gateway
2. Gateway → Claude Sonnet 4
   └── Контекст: SOUL + USER + MEMORY + daily logs
3. Claude → решение + возможные tool calls
   └── Brave Search / Mac Node / Memory / Cron
4. Результат → ответ в Telegram
```

### Новостной flow (автономный)

```
1. Cron job → срабатывает по расписанию (UTC)
2. Дедупликация → загрузить sent-digests.json
3. Brave Search → 7 категорий новостей
4. Multi-armed bandit → отбор источников
5. Dual Rating Filter → ранжирование
6. Telegram Delivery → каждая новость = отдельное сообщение → @newsneiron
7. Обновить sent-digests.json
```

---

## Связь компонентов

| Компонент              | Функция                             | Ключевые файлы                              |
| ---------------------- | ----------------------------------- | ------------------------------------------- |
| **OpenClaw Gateway**   | Маршрутизация всех сообщений        | `openclaw.json`, `openclaw-gateway.service` |
| **AGENTS.md** (сервер) | Инструкции агента при каждой сессии | `server-workspace/AGENTS.md`                |
| **Digest Skill**       | Логика сбора и публикации новостей  | `skills/digest/SKILL.md`                    |
| **Git Sync Skill**     | Авто-коммит изменений workspace     | `~/.openclaw/skills/git-sync/SKILL.md`      |
| **Heartbeat**          | Периодические фоновые проверки      | `HEARTBEAT.md`                              |

---

## Принципы системы

1. **Single source of truth** — каждая настройка живёт в одном месте
2. **Privacy first** — всё self-hosted, Tailscale для шифрования
3. **Adaptive learning** — система сама улучшается через рейтинги и рефлексию
4. **Fail-safe** — systemd Restart=always, транзакционные бэкапы, allowlists
5. **Git as sync layer** — workspace бота = git-репо → изменения доступны на всех устройствах

---

## 🔗 Связанные документы

- [INDEX.md](./.ai/INDEX.md) — единая навигация
- [SNAPSHOT.md](./.ai/SNAPSHOT.md) — текущий статус
- [BACKLOG.md](./.ai/BACKLOG.md) — план разработки
- [.cursor/deployment/README.md](./.cursor/deployment/README.md) — детали деплоя
- [.cursor/deployment/WORKFLOWS.md](./.cursor/deployment/WORKFLOWS.md) — схемы автоматизаций

---

_Последнее обновление: 2026-02-19_
